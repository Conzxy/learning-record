# Hash分片集群的策略
本文仅讨论hash分片策略。

先说一下，MOD N（N是指机器数目）方法是不可取的[1]，因为一旦分母变化，取模结果将会大幅度变化，可能导致多个节点的多个键同时失效，可能导致大量数据在节点间进行迁移，开销巨大。

## 固定总分片数
设置一个预配置的总分片数，并贯穿整个集群不修改。如此一来，每个节点管理多个分片，且几乎相等（某些节点可能会多一个分片）。
这样，在rebalance过程中，只需要去偷或还某些分片即可，不会导致大多数键均会失效而导致发生大量的数据迁移。
进一步扩展的话，可以由用户指定分片数，从而使得承载能力更强的机器管理更多的分片，这样可以更均衡地管理数据。

## 一致性哈希
一致性哈希最早是为解决分布式缓存系统负载均衡而诞生的算法。它和固定总分片数有点类似，也是为了避免MOD N导致的弊端。
大致逻辑是一有hash ring，针对每个机器的unique identifier，在哈希环上都有一个位置。当决定一个key属于哪个机器时，对key进行hash并选择顺时针方向上最近的机器。这种方式使得集群增加或减少节点时，只会影响到相邻的下一个节点（顺时针）[2]。
但是，一致性哈希的弊端很明显，那就是分区并不均衡，可能导致大多数负载落在一个机器上，而其他机器相对空闲。
为了缓解这个问题，引入了虚拟节点（virtual node）放在哈希环上，这些虚拟节点属于一个实际节点，目的在于尽可能的将范围进一步拆分从而使得一些负载落在其他节点的虚拟节点上。[2]
除此之外，一致性哈希由于是通过哈希值和节点的节点的哈希值来确定实际节点，因此并没有明确的范围概念，因此难以由用户指定范围。

## 动态分片
动态分片是一种适应于当前集群大小的分片策略。具体来说，通常会设置一个数据最大临界值（threshold）来决定节点什么时候进行分裂（split），将多出来的数据分到一个新的节点去（至于分多少应该是用户指定）。同时设置一个最小临界值来决定节点什么时候可以进行合并（merge）。
动态分片初始通常是一个节点来处理请求，而其他节点等待第一个节点进行分裂从而被调度存储多出来的数据。这会导致集群在一开始会由一个节点处理所有请求，而其他节点处于空闲状态。
为了避免这种情况，可以采用 **预分裂（pre-spliting）** 的方式来使得初期也能有多个节点能够处理请求。

## 对比

| 方法 | 优点 | 缺点 | 缺点缓解措施 |
| -- | -- | -- | -- |
| 固定分片数 | 1. 集群中每个节点均可被调度<br>2. 实现相对简单（不需要将哈希值划分为数值范围）<br>3. 分片个数均匀无偏<br>4. 支持机器差异配置（自定义分片个数） | 1. 节点数受限于固定分片数<br>2. 只考虑分片个数而没有考虑数据大小| 1. 当节点数等同于分片数时，切换为动态分片策略<br> |
| 一致性哈希| 1. 再平衡只影响相邻一个节点<br>| 1. 分片不均匀<br>2. 不支持机器差异配置（难以自定义分片个数或数据大小） | 1. 引入虚拟节点 |
| 动态分片 | 1. 存储节点适应集群的数据大小<br>2. 理论上节点数没有限制<br>3. 支持机器差异配置（自定义分裂/合并临界值） | 1. 当集群数据大小不够大的时候，只有少数节点可被调度<br>2. 哈希范围可能有偏（非对等切分） | 1. 支持 `pre-spliting` 配置<br>2. 根据数据大小进行分裂进行倾斜修正 |  

这里值得一说的是 **固定分片数+动态分片** 的Hybrid方法[3]，当固定分片数=节点数时，节点数已经达到了该集群配置的上限，如果结合动态分配策略，支持进一步的分裂的话，那么节点数可以突破该限制，但这也要求实现更为复杂，比如实现必须将哈希值划分为数值范围而不是根据原来的分片范围。

## Reference
[1] Martin Kleppmann. "Designing Data-Intensive Applications," pages 210, March 2017.
[2] Tim Roughgarden, Gregory Valiant. "CS168: The Modern Algorithmic Toolbox Lecture #1: Introduction and Consistent Hashing," https://web.stanford.edu/class/cs168/l/l1.pdf, pages 4-6, March 28, 2022.
[3] Martin Kleppmann. "Designing Data-Intensive Applications," pages 211, March 2017.